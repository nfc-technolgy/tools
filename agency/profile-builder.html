<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/d577c668de71834ffb177ae13891eae7f182635a.png">

    <style>
        :root {
            --primary-color: #007bff;
            --primary-color-hover: #0056b3;
            --background-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --input-border: #ced4da;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        html.dark {
            --primary-color: #4dabf7;
            --primary-color-hover: #1c7ed6;
            --background-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --input-border: #495057;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            padding-top: 100px;
        }
        
        /* --- Page Routing --- */
        .page { display: none; }
        .page.active { display: block; }

        /* --- Top Menu Bar --- */
        .top-menu-bar {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            width: calc(100% - 2rem); max-width: 1200px; z-index: 1000;
            background-color: color-mix(in srgb, var(--card-bg) 85%, transparent);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow); border-radius: 12px; padding: 0 1rem;
        }
        .top-menu-content { height: 60px; display: flex; align-items: center; justify-content: space-between; }
        .fab {
            width: 36px; height: 36px; border-radius: 50%;
            background-color: var(--background-color); color: var(--text-primary);
            border: 1px solid var(--input-border); display: flex;
            justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s ease;
        }
        .fab:hover { background-color: var(--input-border); transform: scale(1.1); }
        
        /* --- Profile Grid --- */
        #profile-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .profile-card {
            background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: var(--shadow);
            overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .profile-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .profile-card .card-banner { height: 100px; background-color: var(--primary-color); }
        .profile-card .card-photo {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin: -40px auto 0; border: 4px solid var(--card-bg);
            background-color: var(--text-secondary);
        }

        /* --- Editor Mobile Preview --- */
        .mobile-mockup {
            background: #111; padding: 40px 12px; border-radius: 36px;
            box-shadow: inset 0 0 10px #000, 0 10px 30px rgba(0,0,0,0.3);
            position: sticky; top: 1rem;
        }
        .mobile-mockup .screen {
            background: var(--background-color); color: var(--text-primary);
            height: 640px; border-radius: 20px; overflow-y: auto; overflow-x: hidden;
            position: relative;
        }
        
        /* Drag and Drop styles */
        .draggable { cursor: grab; user-select: none; }
        .draggable:active { cursor: grabbing; }
        .drag-over { border: 2px dashed var(--primary-color); background-color: rgba(0, 123, 255, 0.1); }
        
        /* --- Public Profile --- */
        #public-profile-header { background-size: cover; background-position: center; }
        #public-profile-photo {
            width: 120px; height: 120px; border: 5px solid var(--background-color);
            margin-top: -60px; background-color: var(--text-secondary);
        }
        
        /* --- Utility --- */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 5px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: #2d3748; color: white; padding: 12px 24px;
            border-radius: 9999px; font-size: 0.875rem; opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1200;
        }
        html.dark #toast { background-color: #e9ecef; color: #121212; }
        #toast.show { opacity: 1; bottom: 30px; }
    </style>
</head>
<body class="transition-colors duration-300">

    <!-- Top Menu Bar -->
    <div class="top-menu-bar">
        <div class="top-menu-content">
            <div class="flex items-center gap-3">
                <img src="https://bucket.mlcdn.com/a/3336/3336910/images/d577c668de71834ffb177ae13891eae7f182635a.png" alt="Logo" class="h-8 w-8 rounded-md">
                <span class="font-bold text-lg hidden sm:inline">Profile Dashboard</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="fab" title="Homepage" id="home-btn"><i class="fa fa-home"></i></div>
                <div class="fab" title="Settings" id="settings-btn"><i class="fa fa-cog"></i></div>
                <div class="fab" id="darkModeToggle" title="Change Theme">
                    <i class="fa-solid fa-sun block dark:hidden"></i>
                    <i class="fa-solid fa-moon hidden dark:block"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4">

        <!-- PAGE 1: Home / Profile Grid -->
        <div id="page-home" class="page">
            <h1 class="text-3xl font-bold mb-6 text-center">User Profiles</h1>
            <div id="loader" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-4xl text-[var(--primary-color)]"></i>
                <p class="mt-2 text-lg text-secondary">Loading Profiles...</p>
            </div>
            <div id="error-message" class="hidden text-center py-10"></div>
            <div id="profile-grid">
                <!-- User profile cards will be injected here -->
            </div>
        </div>

        <!-- PAGE 2: Profile Editor -->
        <div id="page-editor" class="page">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Left Panel: Preview -->
                <aside class="lg:w-1/3 xl:w-1/4">
                    <div class="mobile-mockup">
                        <div id="preview-screen" class="screen custom-scrollbar">
                           <!-- Mobile preview will be rendered here -->
                        </div>
                    </div>
                </aside>
                
                <!-- Right Panel: Form -->
                <main class="flex-1">
                    <form id="profile-form" class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Edit Profile</h2>
                            <div>
                                <button type="button" id="copy-url-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm font-semibold py-2 px-4 rounded-lg mr-2">
                                    <i class="fas fa-copy mr-2"></i>Copy URL
                                </button>
                                <button type="submit" id="save-changes-btn" class="bg-[var(--primary-color)] hover:bg-[var(--primary-color-hover)] text-white font-bold py-2 px-6 rounded-lg">
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- General Settings -->
                        <div class="p-5 bg-[var(--card-bg)] rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold border-b border-[var(--input-border)] pb-3 mb-4">General</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Header Color</label><input type="color" id="header_color" class="mt-1 block w-full h-10 rounded-md"></div>
                                <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Header Image URL</label><input type="url" id="header_image" placeholder="https://..." class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-transparent p-2"></div>
                                <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Profile Picture URL</label><input type="url" id="profile_picture" placeholder="https://..." class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-transparent p-2"></div>
                                <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Primary Color</label><input type="color" id="primary_color" class="mt-1 block w-full h-10 rounded-md"></div>
                            </div>
                        </div>

                        <!-- Fields from Google Sheet -->
                        <div class="p-5 bg-[var(--card-bg)] rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold border-b border-[var(--input-border)] pb-3 mb-4">Profile Data</h3>
                            <div id="form-fields" class="space-y-4">
                                <!-- Dynamic fields from sheet will be injected here -->
                            </div>
                        </div>

                        <!-- Custom Buttons -->
                         <div class="p-5 bg-[var(--card-bg)] rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold border-b border-[var(--input-border)] pb-3 mb-4">Custom Buttons</h3>
                            <div id="custom-buttons-container" class="space-y-3">
                                <!-- Custom button fields will be added here -->
                            </div>
                            <button type="button" id="add-custom-btn" class="mt-4 text-sm font-semibold text-[var(--primary-color)] hover:text-[var(--primary-color-hover)]">
                                <i class="fas fa-plus mr-2"></i>Add Custom Button
                            </button>
                        </div>
                    </form>
                </main>
            </div>
        </div>

        <!-- PAGE 3: Public Profile View -->
        <div id="page-public" class="page">
             <div id="public-profile-container" class="max-w-2xl mx-auto bg-[var(--card-bg)] shadow-lg rounded-b-lg">
                <!-- Public profile content will be injected here -->
            </div>
        </div>
        
        <!-- PAGE 4: Settings -->
        <div id="page-settings" class="page max-w-2xl mx-auto">
             <div class="p-8 bg-[var(--card-bg)] rounded-lg shadow-md">
                <h1 class="text-3xl font-bold mb-6">Settings</h1>
                <form id="settings-form">
                    <div class="space-y-4">
                        <div>
                            <label for="sheet-url-input" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Google Apps Script URL</label>
                            <input type="url" id="sheet-url-input" placeholder="Enter your Web App URL from Google Apps Script" class="w-full rounded-md border border-[var(--input-border)] bg-transparent p-3 focus:ring-2 focus:ring-[var(--primary-color)]">
                            <p class="text-xs text-gray-500 mt-2">This URL is used to fetch and update your profile data from the linked Google Sheet.</p>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                         <button type="submit" class="bg-[var(--primary-color)] hover:bg-[var(--primary-color-hover)] text-white font-bold py-2 px-6 rounded-lg">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Toast element for notifications -->
    <div id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let allUsers = [];
    let currentUser = null;
    let settings = {
        sheetUrl: ''
    };
    let draggedElement = null;

    // --- DOM ELEMENT SELECTORS ---
    const pages = {
        home: document.getElementById('page-home'),
        editor: document.getElementById('page-editor'),
        public: document.getElementById('page-public'),
        settings: document.getElementById('page-settings'),
    };
    const loader = document.getElementById('loader');
    const errorMessage = document.getElementById('error-message');
    const profileGrid = document.getElementById('profile-grid');
    const formFields = document.getElementById('form-fields');
    const previewScreen = document.getElementById('preview-screen');

    // --- CORE APP LOGIC ---

    /**
     * Initializes the application, loads settings, and handles routing.
     */
    function init() {
        // Load settings from localStorage
        const savedSettings = localStorage.getItem('profileDashboardSettings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
            document.getElementById('sheet-url-input').value = settings.sheetUrl;
        }

        // Set initial theme
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        addEventListeners();
        window.addEventListener('hashchange', handleRouting); // Listen for hash changes
        handleRouting(); // Initial route handling
    }
    
    /**
     * Shows a specific page and hides others.
     * @param {string} pageId - The ID of the page to show ('home', 'editor', etc.).
     */
    function showPage(pageId) {
        Object.values(pages).forEach(page => page.classList.remove('active'));
        if (pages[pageId]) {
            pages[pageId].classList.add('active');
            window.scrollTo(0, 0);
        }
    }

    /**
     * Parses the URL to determine which page and data to display.
     */
    async function handleRouting() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const view = params.get('view');
        const userId = params.get('user');
        const editId = params.get('edit');

        if (view === 'settings') {
            showPage('settings');
        } else if (userId) {
            showPage('public');
            await fetchAndRenderPublicProfile(userId);
        } else if (editId) {
            showPage('editor');
            await fetchAndRenderEditor(editId);
        } else {
            showPage('home');
            await fetchAndRenderHomepage();
        }
    }
    
    // --- DATA FETCHING & RENDERING ---

    /**
     * Fetches all user data from the Google Sheet and renders the homepage grid.
     */
    async function fetchAndRenderHomepage() {
        if (!settings.sheetUrl) {
            loader.classList.add('hidden');
            errorMessage.innerHTML = 'Google Apps Script URL is not configured. <a href="#view=settings" class="text-[var(--primary-color)] underline">Go to Settings</a> to add it.';
            errorMessage.classList.remove('hidden');
            return;
        }

        loader.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        profileGrid.innerHTML = '';

        try {
            const response = await fetch(`${settings.sheetUrl}?action=getAllUsers`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                allUsers = data.data;
                renderProfileGrid(allUsers);
            } else {
                throw new Error(data.message || 'Failed to load profiles.');
            }
        } catch (error) {
            console.error('Error fetching profiles:', error);
            errorMessage.textContent = `Error: ${error.message}. Please check your script URL and Sheet permissions.`;
            errorMessage.classList.remove('hidden');
        } finally {
            loader.classList.add('hidden');
        }
    }
    
    /**
     * Renders the grid of user profiles on the homepage.
     * @param {Array} users - An array of user objects.
     */
    function renderProfileGrid(users) {
        profileGrid.innerHTML = users.map(user => `
            <div class="profile-card" data-userid="${user.id}">
                <div class="card-banner" style="background-color: ${user.header_color || 'var(--primary-color)'}; background-image: url(${user.header_image || ''}); background-size: cover; background-position: center;"></div>
                <div class="p-4 text-center">
                    <img src="${user.profile_picture || 'https://placehold.co/80x80/6c757d/e9ecef?text=' + (user.name ? user.name.charAt(0) : 'U')}" alt="Profile photo of ${user.name}" class="card-photo">
                    <h3 class="font-bold text-lg mt-2 text-primary">${user.name || 'Unnamed Profile'}</h3>
                    <p class="text-sm text-secondary">${user.title || ''}${user.company ? ' at ' + user.company : ''}</p>
                </div>
            </div>
        `).join('');

        document.querySelectorAll('.profile-card').forEach(card => {
            card.addEventListener('click', () => {
                const userId = card.dataset.userid;
                window.location.hash = `edit=${userId}`;
            });
        });
    }

    /**
     * Fetches data for a single user and renders the editor page.
     * @param {string} userId - The unique ID of the user to edit.
     */
    async function fetchAndRenderEditor(userId) {
         // Show a loading state in the editor
        formFields.innerHTML = '<p>Loading editor...</p>';
        previewScreen.innerHTML = '';
        
        try {
            const response = await fetch(`${settings.sheetUrl}?action=getUser&id=${userId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (data.status === 'success') {
                currentUser = data.data;
                renderEditorForm(currentUser);
                renderEditorPreview(currentUser);
            } else {
                 throw new Error(data.message || `User with ID ${userId} not found.`);
            }
        } catch(error) {
            console.error('Error fetching user for editing:', error);
            pages.editor.innerHTML = `<div class="text-center p-10 text-red-500">${error.message}</div>`;
        }
    }
    
     /**
     * Fetches data for a single user and renders the public profile page.
     * @param {string} userId - The unique ID of the user to display.
     */
    async function fetchAndRenderPublicProfile(userId) {
        const container = document.getElementById('public-profile-container');
        container.innerHTML = '<p class="p-8 text-center">Loading profile...</p>';
        try {
            const response = await fetch(`${settings.sheetUrl}?action=getUser&id=${userId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.status === 'success') {
                renderPublicProfile(data.data);
            } else {
                throw new Error(data.message || `Profile with ID ${userId} not found.`);
            }
        } catch(error) {
            console.error('Error fetching public profile:', error);
            container.innerHTML = `<div class="text-center p-10 text-red-500">${error.message}</div>`;
        }
    }


    /**
     * Renders the form on the editor page based on user data.
     * @param {object} user - The user data object.
     */
    function renderEditorForm(user) {
        // Populate general settings
        document.getElementById('header_color').value = user.header_color || '#007bff';
        document.getElementById('header_image').value = user.header_image || '';
        document.getElementById('profile_picture').value = user.profile_picture || '';
        document.getElementById('primary_color').value = user.primary_color || '#007bff';

        // Populate dynamic fields from sheet data
        const dataFields = Object.keys(user).filter(key => !['id', 'header_color', 'header_image', 'profile_picture', 'primary_color', 'custom_buttons', 'display_options'].includes(key));
        const displayOptions = user.display_options || {};

        formFields.innerHTML = dataFields.map(key => `
            <div>
                <label class="block text-sm font-medium text-[var(--text-secondary)] capitalize">${key.replace(/_/g, ' ')}</label>
                <div class="flex items-center gap-2 mt-1">
                    <input type="text" name="${key}" value="${user[key] || ''}" class="flex-grow w-full rounded-md border border-[var(--input-border)] bg-transparent p-2">
                    <div class="flex items-center" title="Show as Social Icon">
                        <input type="checkbox" id="icon-check-${key}" name="icon-check-${key}" class="h-4 w-4 rounded" ${displayOptions[key]?.asIcon ? 'checked' : ''}>
                        <label for="icon-check-${key}" class="ml-1"><i class="fas fa-share-alt"></i></label>
                    </div>
                    <div class="flex items-center" title="Show as Button">
                        <input type="checkbox" id="btn-check-${key}" name="btn-check-${key}" class="h-4 w-4 rounded" ${displayOptions[key]?.asButton ? 'checked' : ''}>
                        <label for="btn-check-${key}" class="ml-1"><i class="fas fa-link"></i></label>
                    </div>
                </div>
            </div>
        `).join('');
        
        // TODO: Render custom buttons form
    }

    /**
     * Renders the mobile preview on the editor page.
     * @param {object} user - The user data object.
     */
    function renderEditorPreview(user) {
        const displayOptions = user.display_options || {};
        const socialIcons = [];
        const profileButtons = [];

        Object.keys(user).forEach(key => {
            if (displayOptions[key]?.asIcon && user[key]) {
                socialIcons.push({key, value: user[key], order: displayOptions[key].order || 0});
            }
            if (displayOptions[key]?.asButton && user[key]) {
                profileButtons.push({key, value: user[key], label: key.replace(/_/g, ' '), order: displayOptions[key].order || 0});
            }
        });
        
        // Sort based on saved order
        socialIcons.sort((a,b) => a.order - b.order);
        profileButtons.sort((a,b) => a.order - b.order);

        const socialIconsHTML = socialIcons.map(item => `
            <a href="#" class="text-2xl text-gray-500 draggable" draggable="true" data-key="${item.key}"><i class="fab fa-${item.key}"></i></a>
        `).join('') || '<p class="text-xs text-center text-gray-400">No social icons selected.</p>';
        
        const buttonsHTML = profileButtons.map(item => `
            <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-200 text-gray-800 draggable" draggable="true" data-key="${item.key}">${item.label}</button>
        `).join('') || '<p class="text-xs text-center text-gray-400">No buttons selected.</p>';


        previewScreen.innerHTML = `
            <div class="h-32" style="background-color: ${user.header_color || '#007bff'}; background-image: url(${user.header_image || ''}); background-size:cover; background-position:center;"></div>
            <div class="relative text-center p-4">
                <img src="${user.profile_picture || 'https://placehold.co/80x80'}" class="h-20 w-20 rounded-full object-cover mx-auto -mt-12 border-4 border-white dark:border-gray-800">
                <h3 class="font-bold text-lg mt-2">${user.name || 'User Name'}</h3>
                <p class="text-sm text-[var(--text-secondary)]">${user.title || 'Title'} at ${user.company || 'Company'}</p>
                
                <div id="preview-social-icons" class="flex justify-center gap-4 my-4">
                    ${socialIconsHTML}
                </div>
                
                <div id="preview-buttons" class="space-y-2">
                    <button class="w-full text-center py-2 px-4 rounded-lg bg-[var(--primary-color)] text-white">Download Contact</button>
                    ${buttonsHTML}
                </div>
            </div>
        `;
        addDragAndDropListeners();
    }

    /**
     * Renders the final public profile view.
     * @param {object} user - The user data object.
     */
    function renderPublicProfile(user) {
        // This is a simplified version. The final version will be similar to the preview logic.
        const container = document.getElementById('public-profile-container');
        const socialIcons = [];
        const profileButtons = [];
        const displayOptions = user.display_options || {};

         Object.keys(user).forEach(key => {
            if (displayOptions[key]?.asIcon && user[key]) socialIcons.push({key, value: user[key], order: displayOptions[key].order || 0});
            if (displayOptions[key]?.asButton && user[key]) profileButtons.push({key, value: user[key], label: key.replace(/_/g, ' '), order: displayOptions[key].order || 0});
        });

        socialIcons.sort((a,b) => a.order - b.order);
        profileButtons.sort((a,b) => a.order - b.order);

        container.innerHTML = `
            <header id="public-profile-header" class="h-40" style="background-color: ${user.header_color || '#007bff'}; background-image: url(${user.header_image || ''});"></header>
            <div class="p-6 text-center">
                <img id="public-profile-photo" src="${user.profile_picture || 'https://placehold.co/120x120'}" class="rounded-full object-cover mx-auto">
                <h1 class="text-3xl font-bold mt-4">${user.name || 'User Name'}</h1>
                <p class="text-lg text-[var(--text-secondary)] mt-1">${user.title || 'Title'} at ${user.company || 'Company'}</p>
                
                <div class="flex justify-center gap-5 my-6">
                    ${socialIcons.map(i => `<a href="${i.value}" target="_blank" class="text-3xl text-gray-500 hover:text-[var(--primary-color)]"><i class="fab fa-${i.key}"></i></a>`).join('')}
                </div>

                <div class="space-y-3 max-w-md mx-auto">
                     <a href="#" class="block w-full text-center py-3 px-4 rounded-lg bg-[var(--primary-color)] text-white font-semibold">Download Contact</a>
                    ${profileButtons.map(b => `<a href="${b.value}" target="_blank" class="block w-full text-center py-3 px-4 rounded-lg bg-gray-200 dark:bg-gray-700 text-primary font-semibold">${b.label}</a>`).join('')}
                </div>
            </div>
            ${user.location ? `<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(user.location)}&output=embed" width="100%" height="250" style="border:0;" allowfullscreen="" loading="lazy"></iframe>` : ''}
            <footer class="p-6 text-center" style="background-color: ${user.primary_color || 'var(--primary-color)'};">
                ${user.footer_logo ? `<img src="${user.footer_logo}" class="h-[70px] w-[70px] object-contain mx-auto mb-4">` : ''}
                <p class="text-white text-opacity-80" style="font-size: 10px;">Powered with ⭐️ by NFC Technology</p>
            </footer>
        `;
    }


    // --- EVENT LISTENERS & HANDLERS ---
    
    function addEventListeners() {
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });

        document.getElementById('home-btn').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = '';
        });

        document.getElementById('settings-btn').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.hash = 'view=settings';
        });
        
        document.getElementById('settings-form').addEventListener('submit', handleSaveSettings);
        
        document.getElementById('profile-form').addEventListener('input', () => {
            // Live update preview on form change
            // This is a simplified version; a real implementation would be more efficient
            const formData = new FormData(document.getElementById('profile-form'));
            const updatedUser = { ...currentUser };
            updatedUser.display_options = updatedUser.display_options || {};

            for (let [key, value] of formData.entries()) {
                if(key.startsWith('icon-check-')) {
                    const field = key.replace('icon-check-', '');
                    updatedUser.display_options[field] = {...updatedUser.display_options[field], asIcon: true};
                } else if (key.startsWith('btn-check-')) {
                    const field = key.replace('btn-check-', '');
                    updatedUser.display_options[field] = {...updatedUser.display_options[field], asButton: true};
                } else {
                    updatedUser[key] = value;
                }
            }
             // Handle unchecked boxes
            const allCheckboxes = document.querySelectorAll('#form-fields input[type="checkbox"]');
            allCheckboxes.forEach(cb => {
                if(!cb.checked) {
                    if(cb.name.startsWith('icon-check-')) {
                        const field = cb.name.replace('icon-check-', '');
                        if(updatedUser.display_options[field]) updatedUser.display_options[field].asIcon = false;
                    } else if (cb.name.startsWith('btn-check-')) {
                        const field = cb.name.replace('btn-check-', '');
                        if(updatedUser.display_options[field]) updatedUser.display_options[field].asButton = false;
                    }
                }
            });

            renderEditorPreview(updatedUser);
        });

         document.getElementById('copy-url-btn').addEventListener('click', () => {
            const baseUrl = window.location.href.split('#')[0];
            const url = `${baseUrl}#user=${currentUser.id}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Public URL copied to clipboard!');
            }).catch(err => {
                showToast('Failed to copy URL.');
                console.error('Copy failed', err);
            });
        });
    }

    function addDragAndDropListeners() {
        const draggables = previewScreen.querySelectorAll('.draggable');
        const containers = [
            document.getElementById('preview-social-icons'),
            document.getElementById('preview-buttons')
        ];

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('opacity-50');
                draggedElement = draggable;
            });
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('opacity-50');
                draggedElement = null;
            });
        });

        containers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                container.classList.add('drag-over');
            });
            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });
            container.addEventListener('drop', e => {
                e.preventDefault();
                container.classList.remove('drag-over');
                if (draggedElement) {
                    container.appendChild(draggedElement);
                    updateDisplayOrder();
                }
            });
        });
    }
    
    /**
     * Updates the order of items in the currentUser object after a drag-and-drop operation.
     */
    function updateDisplayOrder() {
        if (!currentUser) return;
        currentUser.display_options = currentUser.display_options || {};

        const iconNodes = Array.from(document.querySelectorAll('#preview-social-icons .draggable'));
        iconNodes.forEach((node, index) => {
            const key = node.dataset.key;
            currentUser.display_options[key] = { ...currentUser.display_options[key], order: index };
        });

        const buttonNodes = Array.from(document.querySelectorAll('#preview-buttons .draggable'));
        buttonNodes.forEach((node, index) => {
            const key = node.dataset.key;
            currentUser.display_options[key] = { ...currentUser.display_options[key], order: index };
        });
        showToast('Order updated. Save changes to make it permanent.');
    }


    /**
     * Handles saving the settings form.
     * @param {Event} e - The form submission event.
     */
    function handleSaveSettings(e) {
        e.preventDefault();
        settings.sheetUrl = document.getElementById('sheet-url-input').value.trim();
        localStorage.setItem('profileDashboardSettings', JSON.stringify(settings));
        showToast('Settings saved successfully!');
        // Go to homepage to try the new URL
        setTimeout(() => {
            window.location.hash = '';
        }, 1000);
    }

    // --- UTILITY FUNCTIONS ---
    
    /**
     * Displays a short-lived notification message.
     * @param {string} message - The message to display.
     */
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
    
    // --- APP INITIALIZATION ---
    init();
});
</script>

</body>
</html>

