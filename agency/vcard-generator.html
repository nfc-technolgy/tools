<!DOCTYPE html>
<html lang="es"> <!-- Set default language to Spanish -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="app_title">vCard Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Favicon -->
    <link rel="icon" href="https://bucket.mlcdn.com/a/3336/3336910/images/d577c668de71834ffb177ae13891eae7f182635a.png">
    
    <style>
        /* Custom styles to complement Tailwind CSS */
        :root {
            --primary-color: #000000;
            --primary-color-hover: #967e2d;
            --background-color: #f7fafc;
            --card-bg: #ffffff;
            --text-color: #4a5568;
            --text-primary: #1f2937; /* For main text content */
            --text-secondary: #4b5563; /* For subtitles and secondary text */
            --input-bg: #fff;
            --input-border: #e2e8f0;
            --border-color: #d1d5db; /* General border color */
            --bg-tertiary: #e5e7eb; /* For hover states etc. */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        html.dark {
            --primary-color: #967e2d;
            --primary-color-hover: #525252;
            --background-color: #111111;
            /* Change the card-bg from a solid color to a transparent one for glass effect */
            --card-bg: rgba(46, 46, 46, 0.5); /* This is your original #2e2e2e at 50% opacity */
            --text-color: #e2e8f0;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            
            /* UPDATED INPUT STYLES FOR DARK THEME */
            --input-bg: #000000; /* Pure black background */
            --input-border: #525252; /* A lighter gray for better contrast against black */
            --border-color: #4b5563;
            --bg-tertiary: #4b5563;

            /* Glass Effect Properties */
            --card-border: rgba(255, 255, 255, 0.1); /* Light, transparent border */
            --backdrop-blur: blur(10px); /* The blur effect */
        }

        html { scroll-behavior: smooth; }
        * { padding: 0; margin: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding-top: 120px; /* Add padding to prevent content from being hidden behind the fixed nav bar */
            overflow-x: hidden;
        }

        #preview-banner {
            background-image: url('https://bucket.mlcdn.com/a/3336/3336910/images/cc22ad61e2ee0777b13492321845a5b0d1242e75.png'); /* Add your image URL */
            background-size: cover;
            background-position: center;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        .modal-hidden { display: none; }
        
        #profiles-side-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #profiles-side-panel.open {
            transform: translateX(0);
        }

        #vcard-form input,
        #vcard-form textarea {
            caret-color: var(--primary-color) !important;
        }

        /* Top Menu Bar Styles */
        .top-menu-bar {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 2rem);
            max-width: 1480px;
            background-color: color-mix(in srgb, var(--card-bg) 85%, transparent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            border: 0px solid var(--input-border);
            border-radius: 12px;
            padding: 0 1rem;
            transition: top 0.3s ease-in-out;
        }
        .top-menu-content { height: 80px; display: flex; align-items: center; justify-content: space-between; }
        .logo-container { display: flex; align-items: center; gap: 1rem; }
        #appLogo { height: 40px; width: 40px; object-fit: cover; border-radius: 8px; }
        #appBrandNameDisplay { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .top-menu-actions { display: flex; align-items: center; gap: 0.5rem; }
        .fab {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--background-color);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .fab:hover { background-color: var(--input-border); transform: scale(1.1); }
      .fab:disabled { cursor: not-allowed; opacity: 0.7; }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .btn-primary:hover { background-color: var(--primary-color-hover); }

        /* Custom toast for notifications */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            font-size: 0.875rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
            z-index: 1200;
        }
        #toast.show { opacity: 1; visibility: visible; bottom: 30px; }

    </style>
    <script>
        // Set initial theme based on localStorage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
        // Set initial primary color from localStorage
        const savedColor = localStorage.getItem('vcard-primary-color');
        if (savedColor) {
            document.documentElement.style.setProperty('--primary-color', savedColor);
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <!-- Top Menu Bar -->
    <div class="top-menu-bar">
        <div class="top-menu-content">
            <div class="logo-container">
                <img id="appLogo" src="https://bucket.mlcdn.com/a/3336/3336910/images/d577c668de71834ffb177ae13891eae7f182635a.png" alt="Signature Logo">
                <span id="appBrandNameDisplay" class="hidden sm:inline" data-lang-key="header_title">vCard Creator</span>
            </div>
        
            <div class="top-menu-actions">
                <div class="fab" id="viewSavedSignaturesBtn" title="View Saved Profiles"><i class="fas fa-bookmark"></i></div>
                <!-- Home Icon -->
                <div class="fab" title="Homepage" onclick="window.open('https://bebell-digital-solutions.github.io/easylistings-agency', '_self')"><i class="fa fa-home"></i></div>  
                <div class="fab" title="Help Center" onclick="showToast('Help center will be available soon!')"><i class="fa fa-info-circle"></i></div>
                <!-- Translation Icon -->
                <div class="fab" id="languageToggleBtn" title="English 🇬🇧"><i class="fa fa-globe"></i></div>   
                <div class="fab" id="darkModeToggle" title="Change Theme">
                    <i class="fa-solid fa-sun block dark:hidden"></i>
                    <i class="fa-solid fa-moon hidden dark:block"></i>
                </div>
                <button id="saveProfileBtnTop" class="btn-primary ml-2 hidden sm:block" data-lang-key="save_profile_button">Save Profile</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <main class="flex flex-col lg:flex-row gap-8">
            
            <!-- Left Column: Form -->
            <div class="flex-1 h-[calc(100vh-220px)] overflow-y-auto custom-scrollbar pr-4">
                <form id="vcard-form" class="space-y-6">
                    <!-- Name Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_name">Name</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_prefix">Prefix</label><input type="text" id="prefix" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_suffix">Suffix</label><input type="text" id="suffix" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_first">First Name</label><input type="text" id="firstname" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_middle">Middle Name</label><input type="text" id="middlename" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_last">Last Name</label><input type="text" id="lastname" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="name_nickname">Nickname</label><input type="text" id="nickname" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>
                        
                    <!-- Images Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_images">Images</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="images_photo_upload">Upload Photo</label>
                                <input type="file" id="photo-upload" accept="image/png, image/jpeg, image/gif" class="mt-1 block w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)]/10 file:text-[var(--primary-color)] hover:file:bg-[var(--primary-color)]/20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="images_logo_upload">Upload Logo</label>
                                <input type="file" id="logo-upload" accept="image/png, image/jpeg, image/gif" class="mt-1 block w-full text-sm text-[var(--text-secondary)] file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-color)]/10 file:text-[var(--primary-color)] hover:file:bg-[var(--primary-color)]/20">
                            </div>
                        </div>
                    </div>

                    <!-- Work Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_work">Work</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="work_org">Organization</label><input type="text" id="organization" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="work_title">Title</label><input type="text" id="title" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="work_role">Role</label><input type="text" id="role" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="work_url">Work URL</label><input type="url" id="work_url" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Emails Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_emails">Emails</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="email_personal">Email</label><input type="email" id="email" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="email_work">Work Email</label><input type="email" id="work_email" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Phones Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_phones">Phones</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_home">Home Phone</label><input type="tel" id="home_phone" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_work">Work Phone</label><input type="tel" id="work_phone" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_cell">Cell Phone</label><input type="tel" id="cell_phone" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_pager">Pager</label><input type="tel" id="pager_phone" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_home_fax">Home Fax</label><input type="tel" id="home_fax" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="phone_work_fax">Work Fax</label><input type="tel" id="work_fax" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Home Address Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_home_address">Home Address</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="sm:col-span-2"><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_street">Street</label><input type="text" id="home_street" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_city">City</label><input type="text" id="home_city" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_state">State / Province</label><input type="text" id="home_state" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_zip">Postal Code</label><input type="text" id="home_postal" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_country">Country</label><input type="text" id="home_country" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Work Address Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_work_address">Work Address</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="sm:col-span-2"><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_street">Street</label><input type="text" id="work_street" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_city">City</label><input type="text" id="work_city" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_state">State / Province</label><input type="text" id="work_state" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_zip">Postal Code</label><input type="text" id="work_postal" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="address_country">Country</label><input type="text" id="work_country" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Social -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_social">Social</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">LinkedIn</label><input type="url" id="social_linkedin" placeholder="https://www.linkedin.com/in/YOURPROFILE/" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Twitter</label><input type="url" id="social_twitter" placeholder="https://twitter.com/YOURPROFILE" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Facebook</label><input type="url" id="social_facebook" placeholder="https://www.facebook.com/YOURPROFILE/" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Instagram</label><input type="url" id="social_instagram" placeholder="https://www.instagram.com/YOURPROFILE/" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Threads</label><input type="url" id="social_threads" placeholder="https://www.threads.net/@YOURPROFILE" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">YouTube</label><input type="url" id="social_youtube" placeholder="https://www.youtube.com/c/YOURPROFILE" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">TikTok</label><input type="url" id="social_tiktok" placeholder="https://www.tiktok.com/@YOURPROFILE" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Pinterest</label><input type="url" id="social_pinterest" placeholder="https://www.pinterest.com/YOURPROFILE/" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Discord</label><input type="text" id="social_discord" placeholder="your_username" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Telegram</label><input type="text" id="social_telegram" placeholder="https://t.me/your_username" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="social_whatsapp">WhatsApp</label><input type="tel" id="social_whatsapp" placeholder="+1234567890" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Spotify</label><input type="url" id="social_spotify" placeholder="https://open.spotify.com/user/..." class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                            <div><label class="block text-sm font-medium text-[var(--text-secondary)]">Airbnb</label><input type="url" id="social_airbnb" placeholder="https://www.airbnb.com/users/show/..." class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></div>
                        </div>
                    </div>

                    <!-- Other Section -->
                    <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold border-b border-[var(--border-color)] pb-3 mb-4 text-[var(--text-primary)]" data-lang-key="section_other">Other</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]" data-lang-key="other_note">Note</label>
                                <textarea id="note" rows="4" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)]">UID</label>
                                <input type="text" id="uid" class="mt-1 block w-full rounded-md border border-[var(--input-border)] bg-[var(--input-bg)] shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] text-[var(--text-primary)]">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Right Column: Preview -->
            <div class="lg:w-[26rem] lg:flex-shrink-0">
                <div class="sticky top-8">
                    <h2 class="text-2xl font-bold mb-4 text-[var(--text-primary)]" data-lang-key="preview_title">Preview</h2>
                    <div class="w-full max-w-sm mx-auto bg-[var(--card-bg)] rounded-2xl shadow-lg overflow-hidden">
                        <!-- Preview content -->
                        <div class="w-full max-w-sm h-32 bg-[var(--primary-color)] relative bg-cover bg-center" id="preview-banner">
                            <img id="preview-logo" class="absolute top-4 right-4 h-12 w-12 object-contain" src="" alt="Logo Preview" style="display: none;">
                        </div>
                                <div class="relative p-6">
                                    <div class="absolute -mt-20">
                                        <img id="preview-photo" class="h-24 w-24 rounded-full border-4 border-[var(--card-bg)] object-cover bg-[var(--bg-tertiary)]" src="https://placehold.co/96x96/e2e8f0/64748b?text=Photo" alt="Contact Photo">
                                    </div>
                                    <div class="pt-8 text-center">
                                        <h3 id="preview-name" class="text-xl font-bold text-[var(--text-primary)]" data-lang-key="preview_placeholder_name">Your Name</h3>
                                        <p id="preview-title-org" class="text-sm text-[var(--text-secondary)]" data-lang-key="preview_placeholder_title_org">Title at Organization</p>
                                        <div id="preview-social" class="mt-4 flex justify-center flex-wrap gap-4 text-xl text-[var(--text-secondary)]"></div>
                                    </div>
                                    
                                    <div id="preview-details-container" class="mt-6 border-t border-[var(--border-color)] pt-4 space-y-4 text-sm">
                                        <!-- Contact Info -->
                                        <div id="preview-contact-container" class="hidden">
                                            <h4 data-lang-key="preview_contact" class="font-semibold text-[var(--text-secondary)] mb-2">Contact Information</h4>
                                            <div id="preview-contact-details" class="space-y-2 text-[var(--text-primary)] break-words">
                                                <!-- JS will populate this -->
                                            </div>
                                        </div>
                                        <!-- Work Address -->
                                        <div id="preview-work-address-container" class="hidden">
                                            <h4 data-lang-key="preview_work_address" class="font-semibold text-[var(--text-secondary)] mb-2">Work Address</h4>
                                            <address id="preview-work-address-details" class="not-italic text-[var(--text-primary)]">
                                                <!-- JS will populate this -->
                                            </address>
                                        </div>
                                        <!-- Home Address -->
                                        <div id="preview-home-address-container" class="hidden">
                                            <h4 data-lang-key="preview_home_address" class="font-semibold text-[var(--text-secondary)] mb-2">Home Address</h4>
                                            <address id="preview-home-address-details" class="not-italic text-[var(--text-primary)]">
                                                <!-- JS will populate this -->
                                            </address>
                                        </div>
                                        <!-- Note -->
                                        <div id="preview-note-container" class="hidden">
                                            <h4 data-lang-key="preview_note" class="font-semibold text-[var(--text-secondary)] mb-2">Note</h4>
                                            <p id="preview-note-details" class="text-[var(--text-primary)] whitespace-pre-wrap break-words"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 space-y-4 ml-4 mr-4">
                                <button id="download-btn" class="w-full bg-[var(--primary-color)] hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] dark:focus:ring-offset-[var(--background-color)] transition-transform transform hover:scale-105 disabled:opacity-75 disabled:cursor-not-allowed btn-primary">
                                    <span data-lang-key="download_button">Download vCard</span>
                                </button>
                            </div>
                        </div>
                    </div>
        </main>
        
        <footer class="text-center mt-8 py-4 border-t border-[var(--border-color)]">
            <p class="text-[var(--text-secondary)]" style="font-size: 10px;" data-lang-key="footer_text">Developed with ❤️ by Bebell Digital Solutions.</p>
        </footer>
    </div>
    
    <!-- Profiles Side Panel -->
    <div id="profiles-side-panel" class="fixed top-0 right-0 h-full w-80 bg-[var(--card-bg)] shadow-2xl z-40 p-6 flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-[var(--text-primary)]" data-lang-key="profiles_title">Profiles</h2>
            <button id="profiles-close-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] text-2xl font-bold">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar -mr-4 pr-4">
            <ul id="profiles-list" class="space-y-2">
                <!-- Profile items will be injected here by JS -->
            </ul>
        </div>
        <div class="mt-6">
            <button id="new-profile-btn" class="w-full text-center py-2 px-4 rounded-md bg-[var(--primary-color)] text-white hover:opacity-90 btn-primary">
                <span data-lang-key="new_profile_button">New Profile</span>
            </button>
        </div>
    </div>
    <div id="panel-overlay" class="modal-hidden fixed inset-0 bg-black/60 z-30"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

        // --- STATE & DATA ---
        const translations = {
            en: { app_title: "vCard Creator", header_title: "vCard Creator", header_subtitle: "Generate your personal vCard file easily.", section_name: "Name", name_prefix: "Prefix", name_suffix: "Suffix", name_first: "First Name", name_middle: "Middle Name", name_last: "Last Name", name_nickname: "Nickname", section_work: "Work", work_org: "Organization", work_title: "Title", work_role: "Role", work_url: "Work URL", section_emails: "Emails", email_personal: "Email", email_work: "Work Email", section_phones: "Phones", phone_home: "Home Phone", phone_work: "Work Phone", phone_cell: "Cell Phone", phone_pager: "Pager", phone_home_fax: "Home Fax", phone_work_fax: "Work Fax", section_home_address: "Home Address", section_work_address: "Work Address", address_street: "Street", address_city: "City", address_state: "State / Province", address_zip: "Postal Code", address_country: "Country", section_images: "Images", images_photo_upload: "Upload Photo", images_logo_upload: "Upload Logo", section_social: "Social", social_whatsapp: "WhatsApp", section_other: "Other", other_note: "Note", preview_title: "Preview", preview_placeholder_name: "Your Name", preview_placeholder_title_org: "Title at Organization", preview_social: "Social", download_button: "Download vCard", footer_text: "Developed with ❤️ by Bebell Digital Solutions.", save_profile_button: "Save Profile", profiles_title: "Profiles", new_profile_button: "New Profile", profile_name_placeholder: "Unnamed Profile", settings_save: "Save Configuration", generating_button: "Generating...", preview_contact: "Contact Information", preview_work_address: "Work Address", preview_home_address: "Home Address", preview_note: "Note", no_profiles_text: "No profiles saved yet.", saving_button: "Saving...", save_success_local: "Profile saved to device!", save_success_synced: "Profile saved and synced!", save_fail_sync: "Saved locally, but sync failed.", save_fail_config: "Saved locally. Configure Sheet URL to sync." },
            es: { app_title: "Creador de vCard", header_title: "Creador de vCard", header_subtitle: "Genere su archivo vCard personal fácilmente.", section_name: "Nombre", name_prefix: "Prefijo", name_suffix: "Sufijo", name_first: "Nombre", name_middle: "Segundo Nombre", name_last: "Apellido", name_nickname: "Apodo", section_work: "Trabajo", work_org: "Organización", work_title: "Título", work_role: "Rol", work_url: "URL del Trabajo", section_emails: "Correos Electrónicos", email_personal: "Correo", email_work: "Correo del Trabajo", section_phones: "Teléfonos", phone_home: "Teléfono de Casa", phone_work: "Teléfono del Trabajo", phone_cell: "Celular", phone_pager: "Buscapersonas", phone_home_fax: "Fax de Casa", phone_work_fax: "Fax del Trabajo", section_home_address: "Dirección de Casa", section_work_address: "Dirección del Trabajo", address_street: "Calle", address_city: "Ciudad", address_state: "Estado / Provincia", address_zip: "Código Postal", address_country: "País", section_images: "Imágenes", images_photo_upload: "Subir Foto", images_logo_upload: "Subir Logo", section_social: "Redes Sociales", social_whatsapp: "WhatsApp", section_other: "Otro", other_note: "Nota", preview_title: "Vista Previa", preview_placeholder_name: "Su Nombre", preview_placeholder_title_org: "Título en Organización", preview_social: "Redes Sociales", download_button: "Descargar vCard", footer_text: "Desarrollado con ❤️ por Bebell Digital Solutions.", save_profile_button: "Guardar Perfil", profiles_title: "Perfiles", new_profile_button: "Nuevo Perfil", profile_name_placeholder: "Perfil sin Nombre", settings_save: "Guardar Configuración", generating_button: "Generando...", preview_contact: "Información de Contacto", preview_work_address: "Dirección de Trabajo", preview_home_address: "Dirección de Casa", preview_note: "Nota", no_profiles_text: "Aún no hay perfiles guardados.", saving_button: "Guardando...", save_success_local: "¡Perfil guardado en el dispositivo!", save_success_synced: "¡Perfil guardado y sincronizado!", save_fail_sync: "Guardado localmente, pero falló la sincronización.", save_fail_config: "Guardado local. Configure la URL de la hoja para sincronizar." }
        };
        let currentLang = localStorage.getItem('vcard-lang') || 'es';
        let profiles = [];
        let currentProfileId = null;
        let photoData = { base64: null, type: null };
        let logoData = { base64: null, type: null };


        // --- DOM Elements ---
        const allInputIds = [ 'prefix', 'suffix', 'firstname', 'middlename', 'lastname', 'nickname', 'organization', 'title', 'role', 'work_url', 'email', 'work_email', 'home_phone', 'work_phone', 'cell_phone', 'pager_phone', 'home_fax', 'work_fax', 'home_street', 'home_city', 'home_state', 'home_postal', 'home_country', 'work_street', 'work_city', 'work_state', 'work_postal', 'work_country', 'social_linkedin', 'social_twitter', 'social_facebook', 'social_instagram', 'social_threads', 'social_youtube', 'social_tiktok', 'social_pinterest', 'social_discord', 'social_telegram', 'social_whatsapp', 'social_spotify', 'social_airbnb', 'note', 'uid' ];
        const form = document.getElementById('vcard-form');
        const themeToggle = document.getElementById('darkModeToggle');
        const languageToggleBtn = document.getElementById('languageToggleBtn');
        const downloadBtn = document.getElementById('download-btn');
        const saveProfileBtn = document.getElementById('saveProfileBtnTop');
        const profilesBtn = document.getElementById('viewSavedSignaturesBtn');
        const profilesPanel = document.getElementById('profiles-side-panel');
        const profilesCloseBtn = document.getElementById('profiles-close-btn');
        const profilesList = document.getElementById('profiles-list');
        const newProfileBtn = document.getElementById('new-profile-btn');
        const panelOverlay = document.getElementById('panel-overlay');
        const photoUpload = document.getElementById('photo-upload');
        const logoUpload = document.getElementById('logo-upload');

        // --- FUNCTIONS ---
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) { document.body.removeChild(toast); }
                }, 300);
            }, 3000);
        };

        const toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        };
        
        const setLanguage = (lang) => {
            currentLang = lang;
            localStorage.setItem('vcard-lang', lang);
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                const translation = translations[lang]?.[key] || translations.en[key];
                if (translation) {
                    // This handles buttons that might have a loading spinner inside
                    const childSpan = el.querySelector('span');
                    if(childSpan) {
                         childSpan.textContent = translation;
                    } // This handles the save button which doesn't have a span
                    else if(el.id === 'saveProfileBtnTop' && !el.disabled) {
                        el.textContent = translation;
                    } // This handles all other elements
                    else if (el.id !== 'saveProfileBtnTop'){
                         el.textContent = translation;
                    }
                }
            });
            if (!downloadBtn.disabled) {
                const downloadKey = 'download_button';
                downloadBtn.querySelector('span').textContent = translations[lang]?.[downloadKey] || translations.en[downloadKey];
            }
            if (lang === 'es') { languageToggleBtn.title = "English 🇬🇧"; } 
            else { languageToggleBtn.title = "Español 🇪🇸"; }
            updatePreview();
        };

        const toggleLanguage = () => {
            const newLang = currentLang === 'es' ? 'en' : 'es';
            setLanguage(newLang);
        };

        const socialIconSVG = (type) => {
            const icons = { linkedin: `<i class="fab fa-linkedin"></i>`, twitter: `<i class="fab fa-twitter"></i>`, facebook: `<i class="fab fa-facebook"></i>`, instagram: `<i class="fab fa-instagram"></i>`, threads: `<i class="fab fa-threads"></i>`, youtube: `<i class="fab fa-youtube"></i>`, tiktok: `<i class="fab fa-tiktok"></i>`, pinterest: `<i class="fab fa-pinterest"></i>`, discord: `<i class="fab fa-discord"></i>`, telegram: `<i class="fab fa-telegram"></i>`, whatsapp: `<i class="fab fa-whatsapp"></i>`, spotify: `<i class="fab fa-spotify"></i>`, airbnb: `<i class="fab fa-airbnb"></i>`, };
            return icons[type] || '';
        }

        const updatePreview = () => {
            const getVal = (id) => document.getElementById(id).value.trim();
            
            const fullName = [getVal('prefix'), getVal('firstname'), getVal('middlename'), getVal('lastname'), getVal('suffix')].filter(Boolean).join(' ');
            document.getElementById('preview-name').textContent = fullName || (translations[currentLang]?.preview_placeholder_name || 'Your Name');
            
            const title = getVal('title');
            const org = getVal('organization');
            document.getElementById('preview-title-org').textContent = (title && org) ? `${title} at ${org}` : title || org || (translations[currentLang]?.preview_placeholder_title_org || 'Title at Organization');
            
            const socialFields = [ { type: 'linkedin', url: getVal('social_linkedin') }, { type: 'twitter', url: getVal('social_twitter') }, { type: 'facebook', url: getVal('social_facebook') }, { type: 'instagram', url: getVal('social_instagram') }, { type: 'threads', url: getVal('social_threads') }, { type: 'youtube', url: getVal('social_youtube') }, { type: 'tiktok', url: getVal('social_tiktok') }, { type: 'pinterest', url: getVal('social_pinterest') }, { type: 'discord', url: getVal('social_discord') }, { type: 'telegram', url: getVal('social_telegram') }, { type: 'whatsapp', url: getVal('social_whatsapp') }, { type: 'spotify', url: getVal('social_spotify') }, { type: 'airbnb', url: getVal('social_airbnb') } ];
            const socialHtml = socialFields.filter(s => s.url).map(s => `<a href="${s.url.startsWith('http') ? s.url : `https://${s.url}`}" target="_blank" class="hover:text-[var(--primary-color)]" title="${s.type}">${socialIconSVG(s.type)}</a>`).join('');
            document.getElementById('preview-social').innerHTML = socialHtml;

            const contactDetailsContainer = document.getElementById('preview-contact-container');
            const contactDetailsContent = document.getElementById('preview-contact-details');
            let contactHtml = [];
            if (getVal('email')) contactHtml.push(`<div><i class="fa-solid fa-envelope fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i>${getVal('email')}</div>`);
            if (getVal('work_email')) contactHtml.push(`<div><i class="fa-solid fa-briefcase fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i>${getVal('work_email')}</div>`);
            if (getVal('cell_phone')) contactHtml.push(`<div><i class="fa-solid fa-mobile-screen-button fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i>${getVal('cell_phone')}</div>`);
            if (getVal('work_phone')) contactHtml.push(`<div><i class="fa-solid fa-phone fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i>${getVal('work_phone')} (Work)</div>`);
            if (getVal('home_phone')) contactHtml.push(`<div><i class="fa-solid fa-phone-alt fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i>${getVal('home_phone')} (Home)</div>`);
            if (getVal('work_url')) contactHtml.push(`<div><i class="fa-solid fa-globe fa-fw w-5 mr-2 text-[var(--text-secondary)]"></i><a href="${getVal('work_url')}" target="_blank" class="text-[var(--primary-color)] hover:underline">${getVal('work_url')}</a></div>`);
            
            contactDetailsContainer.classList.toggle('hidden', contactHtml.length === 0);
            contactDetailsContent.innerHTML = contactHtml.join('');

            const formatAddress = (street, city, state, postal, country) => [street, `${city}${state ? ', ' + state : ''} ${postal}`, country].filter(Boolean).join('<br>');
            
            const workAddressContainer = document.getElementById('preview-work-address-container');
            const workAddressContent = document.getElementById('preview-work-address-details');
            const workAddressHtml = formatAddress(getVal('work_street'), getVal('work_city'), getVal('work_state'), getVal('work_postal'), getVal('work_country'));
            workAddressContainer.classList.toggle('hidden', !workAddressHtml);
            workAddressContent.innerHTML = workAddressHtml;

            const homeAddressContainer = document.getElementById('preview-home-address-container');
            const homeAddressContent = document.getElementById('preview-home-address-details');
            const homeAddressHtml = formatAddress(getVal('home_street'), getVal('home_city'), getVal('home_state'), getVal('home_postal'), getVal('home_country'));
            homeAddressContainer.classList.toggle('hidden', !homeAddressHtml);
            homeAddressContent.innerHTML = homeAddressHtml;

            const noteContainer = document.getElementById('preview-note-container');
            const noteContent = document.getElementById('preview-note-details');
            const noteText = getVal('note');
            noteContainer.classList.toggle('hidden', !noteText);
            noteContent.textContent = noteText;
            
            document.getElementById('preview-details-container').classList.toggle('hidden', contactHtml.length === 0 && !workAddressHtml && !homeAddressHtml && !noteText);
        };

        const handleFileChange = (file, dataObject, previewElementId) => {
            const previewImg = document.getElementById(previewElementId);
            const isLogo = previewElementId === 'preview-logo';

            if (!file) {
                dataObject.base64 = null; dataObject.type = null;
                if (isLogo) { previewImg.src = ''; previewImg.style.display = 'none'; } 
                else { previewImg.src = 'https://placehold.co/96x96/e2e8f0/64748b?text=Photo'; }
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                if (isLogo) { previewImg.style.display = 'block'; }
                const [header, base64String] = e.target.result.split(',');
                dataObject.base64 = base64String;
                dataObject.type = file.type;
            };
            reader.readAsDataURL(file);
        };
        
        const foldVCardLine = (line) => {
            const maxLineLength = 75;
            if (line.length <= maxLineLength) return line;
            let result = line.substring(0, maxLineLength);
            let rest = line.substring(maxLineLength);
            while (rest.length > 0) {
                result += '\r\n ' + rest.substring(0, maxLineLength - 1);
                rest = rest.substring(maxLineLength - 1);
            }
            return result;
        }

        const formatImageForVCard = (base64Data, mimeType, field) => {
                 const maxLineLength = 75;
                 const prefix = `${field};ENCODING=b;TYPE=${mimeType.split('/')[1].toUpperCase()}:`;
                 const firstLineSpace = maxLineLength - prefix.length;
                 if (firstLineSpace <= 0) {
                     let result = prefix + '\r\n '; let remainingData = base64Data;
                     while (remainingData.length > 0) {
                         const chunk = remainingData.substring(0, maxLineLength - 1);
                         result += chunk + (remainingData.length > chunk.length ? '\r\n ' : '');
                         remainingData = remainingData.substring(chunk.length);
                     }
                     return result.trim();
                 }
                 let result = prefix + base64Data.substring(0, firstLineSpace);
                 let remainingData = base64Data.substring(firstLineSpace);
                 while (remainingData.length > 0) {
                     const chunk = remainingData.substring(0, maxLineLength - 1);
                     result += '\r\n ' + chunk;
                     remainingData = remainingData.substring(chunk.length);
                 }
                 return result;
        };

        const generateVCF = async () => {
            const getVal = (id) => document.getElementById(id).value.trim();
            let vcfContent = ['BEGIN:VCARD', 'VERSION:3.0'];
            vcfContent.push(`N:${getVal('lastname')};${getVal('firstname')};${getVal('middlename')};${getVal('prefix')};${getVal('suffix')}`);
            vcfContent.push(`FN:${[getVal('prefix'), getVal('firstname'), getVal('middlename'), getVal('lastname'), getVal('suffix')].filter(Boolean).join(' ')}`);
            if(getVal('nickname')) vcfContent.push(`NICKNAME:${getVal('nickname')}`);
            if(getVal('organization')) vcfContent.push(`ORG:${getVal('organization')}`);
            if(getVal('title')) vcfContent.push(`TITLE:${getVal('title')}`);
            if(getVal('role')) vcfContent.push(`ROLE:${getVal('role')}`);
            if(getVal('work_url')) vcfContent.push(`URL;type=WORK:${getVal('work_url')}`);
            if(getVal('email')) vcfContent.push(`EMAIL;type=INTERNET,HOME:${getVal('email')}`);
            if(getVal('work_email')) vcfContent.push(`EMAIL;type=INTERNET,WORK:${getVal('work_email')}`);
            if(getVal('home_phone')) vcfContent.push(`TEL;type=HOME,VOICE:${getVal('home_phone')}`);
            if(getVal('work_phone')) vcfContent.push(`TEL;type=WORK,VOICE:${getVal('work_phone')}`);
            if(getVal('cell_phone')) vcfContent.push(`TEL;type=CELL,VOICE:${getVal('cell_phone')}`);
            if(getVal('pager_phone')) vcfContent.push(`TEL;type=PAGER:${getVal('pager_phone')}`);
            if(getVal('home_fax')) vcfContent.push(`TEL;type=HOME,FAX:${getVal('home_fax')}`);
            if(getVal('work_fax')) vcfContent.push(`TEL;type=WORK,FAX:${getVal('work_fax')}`);
            if(getVal('home_street') || getVal('home_city')) vcfContent.push(`ADR;type=HOME:;;${getVal('home_street')};${getVal('home_city')};${getVal('home_state')};${getVal('home_postal')};${getVal('home_country')}`);
            if(getVal('work_street') || getVal('work_city')) vcfContent.push(`ADR;type=WORK:;;${getVal('work_street')};${getVal('work_city')};${getVal('work_state')};${getVal('work_postal')};${getVal('work_country')}`);
            if (photoData.base64 && photoData.type) { vcfContent.push(formatImageForVCard(photoData.base64, photoData.type, 'PHOTO')); }
            if (logoData.base64 && logoData.type) { vcfContent.push(formatImageForVCard(logoData.base64, logoData.type, 'LOGO')); }
            const socialProfiles = [ {type: 'linkedin', value: getVal('social_linkedin')}, {type: 'twitter', value: getVal('social_twitter')}, {type: 'facebook', value: getVal('social_facebook')}, {type: 'instagram', value: getVal('social_instagram')}, {type: 'threads', value: getVal('social_threads')}, {type: 'youtube', value: getVal('social_youtube')}, {type: 'tiktok', value: getVal('social_tiktok')}, {type: 'pinterest', value: getVal('social_pinterest')}, {type: 'discord', value: getVal('social_discord') ? `https://discord.com/users/${getVal('social_discord')}`:''}, {type: 'telegram', value: getVal('social_telegram')}, {type: 'whatsapp', value: getVal('social_whatsapp') ? `https://wa.me/${getVal('social_whatsapp').replace(/\D/g, '')}`:''}, {type: 'spotify', value: getVal('social_spotify')}, {type: 'airbnb', value: getVal('social_airbnb')} ];
            socialProfiles.forEach(p => { if(p.value) vcfContent.push(`X-SOCIALPROFILE;type=${p.type}:${p.value}`); });
            if(getVal('note')) vcfContent.push(`NOTE:${getVal('note').replace(/\r\n|\r|\n/g, '\\n')}`);
            if(getVal('uid')) vcfContent.push(`UID:${getVal('uid')}`);
            vcfContent.push(`REV:${new Date().toISOString()}`, 'END:VCARD');
            return vcfContent.map(foldVCardLine).join('\r\n');
        };

        const downloadVCF = async () => {
            const downloadBtnSpan = downloadBtn.querySelector('span');
            const generatingText = translations[currentLang]?.generating_button || translations.en.generating_button;
            downloadBtn.disabled = true;
            downloadBtnSpan.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> ${generatingText}`;
            try {
                const vcfContent = await generateVCF();
                const blob = new Blob([vcfContent], { type: 'text/vcard;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const firstname = document.getElementById('firstname').value.trim();
                const lastname = document.getElementById('lastname').value.trim();
                const filename = `${firstname || 'contact'}${lastname ? '_' + lastname : ''}`.replace(/ /g, '_') || 'contact';
                a.href = url; a.download = `${filename}.vcf`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Failed to generate or download vCard:", error);
                showToast("Error generating vCard. Please check the console for details.");
            } finally {
                downloadBtn.disabled = false;
                downloadBtnSpan.textContent = translations[currentLang]?.download_button || translations.en.download_button;
            }
        };
        
        // --- Profile Management ---
        const renderProfilesList = () => {
            profilesList.innerHTML = '';
            if (profiles.length === 0) {
                profilesList.innerHTML = `<li class="text-sm text-center text-[var(--text-secondary)] p-4">${translations[currentLang]?.no_profiles_text || 'No profiles saved yet.'}</li>`;
                return;
            }
            profiles.forEach(profile => {
                const profileName = (profile.firstname || profile.lastname) ? `${profile.firstname || ''} ${profile.lastname || ''}`.trim() : (translations[currentLang].profile_name_placeholder || 'Unnamed Profile');
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-2 rounded-md cursor-pointer hover:bg-[var(--bg-tertiary)] ${profile.id === currentProfileId ? 'bg-[var(--primary-color)]/20' : ''}`;
                li.dataset.id = profile.id;
                li.innerHTML = `<span class="truncate text-[var(--text-primary)]">${profileName}</span><button data-delete-id="${profile.id}" class="text-red-500 hover:text-red-700 text-xs p-1"><i class="fa-solid fa-trash"></i></button>`;
                profilesList.appendChild(li);
            });
        };
        const loadProfilesFromStorage = () => {
            profiles = JSON.parse(localStorage.getItem('vcard-profiles')) || [];
            renderProfilesList();
        };
        
        const clearForm = () => {
            form.reset();
            currentProfileId = null;
            photoData = { base64: null, type: null };
            logoData = { base64: null, type: null };
            document.getElementById('preview-photo').src = 'https://placehold.co/96x96/e2e8f0/64748b?text=Photo';
            const logoImg = document.getElementById('preview-logo');
            logoImg.src = ''; logoImg.style.display = 'none';
            updatePreview(); renderProfilesList();
        };

        const saveCurrentProfile = async () => {
            const saveBtn = document.getElementById('saveProfileBtnTop');
            const originalSaveText = translations[currentLang]?.save_profile_button || translations.en.save_profile_button;
            const savingButtonText = translations[currentLang]?.saving_button || translations.en.saving_button;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> ${savingButtonText}`;

            // --- Part 1: Save to Local Storage ---
            const profileData = { id: currentProfileId || crypto.randomUUID() };
            allInputIds.forEach(id => profileData[id] = document.getElementById(id)?.value || '');
            
            const existingIndex = profiles.findIndex(p => p.id === profileData.id);
            if (existingIndex > -1) { profiles[existingIndex] = profileData; } 
            else { profiles.push(profileData); }
            currentProfileId = profileData.id;
            
            localStorage.setItem('vcard-profiles', JSON.stringify(profiles));
            renderProfilesList();
            
            // --- Part 2: Sync to Google Sheet ---
            const webAppUrl = 'https://script.google.com/macros/s/AKfycbxBKc_--2kXMXT4UpSsAsc4rcdxVDJHPi-49YzkGkQCEgTgJsR8EdigGT60XB964E1H3w/exec'; // !!! IMPORTANT: REPLACE THIS URL !!!
            if (webAppUrl === 'YOUR_WEB_APP_URL') {
                showToast(translations[currentLang]?.save_fail_config || "Saved locally. Configure Sheet URL to sync.");
                console.error("🚨 Google Apps Script Web App URL is not set.");
                saveBtn.disabled = false;
                saveBtn.textContent = originalSaveText;
                return;
            }

            const dataToSync = {};
            allInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) { dataToSync[id] = element.value.trim(); }
            });
            const photoFile = document.getElementById('photo-upload').files[0];
            const logoFile = document.getElementById('logo-upload').files[0];
            dataToSync.photo_filename = photoFile ? photoFile.name : "";
            dataToSync.logo_filename = logoFile ? logoFile.name : "";

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(dataToSync),
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showToast(translations[currentLang]?.save_success_synced || "Profile saved and synced!");
                } else {
                    throw new Error(result.message || "Unknown error from Google Apps Script");
                }
            } catch (error) {
                console.error('Error syncing to Google Sheet:', error);
                showToast(translations[currentLang]?.save_fail_sync || "Saved locally, but sync failed.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalSaveText;
            }
        };

        
        const loadProfile = (id, closePanel = false) => {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;
            clearForm();
            allInputIds.forEach(inputId => {
                if (document.getElementById(inputId)) {
                    document.getElementById(inputId).value = profile[inputId] || '';
                }
            });
            currentProfileId = id;
            updatePreview(); renderProfilesList();
            if (closePanel) { toggleProfilesPanel(); }
        };

        const deleteProfile = (id) => {
            profiles = profiles.filter(p => p.id !== id);
            localStorage.setItem('vcard-profiles', JSON.stringify(profiles));
            if (currentProfileId === id) { clearForm(); } 
            else { renderProfilesList(); }
        };
        
        const toggleProfilesPanel = () => {
            profilesPanel.classList.toggle('open');
            panelOverlay.classList.toggle('modal-hidden');
        };

        // --- EVENT LISTENERS ---
        photoUpload.addEventListener('change', (e) => handleFileChange(e.target.files[0], photoData, 'preview-photo'));
        logoUpload.addEventListener('change', (e) => handleFileChange(e.target.files[0], logoData, 'preview-logo'));
        themeToggle.addEventListener('click', toggleTheme);
        languageToggleBtn.addEventListener('click', toggleLanguage);
        saveProfileBtn.addEventListener('click', saveCurrentProfile);
        newProfileBtn.addEventListener('click', () => { clearForm(); toggleProfilesPanel(); });
        profilesBtn.addEventListener('click', toggleProfilesPanel);
        profilesCloseBtn.addEventListener('click', toggleProfilesPanel);
        panelOverlay.addEventListener('click', toggleProfilesPanel);
        
        profilesList.addEventListener('click', (e) => {
            const target = e.target.closest('li');
            const deleteButton = e.target.closest('button');
            if (deleteButton && deleteButton.dataset.deleteId) { deleteProfile(deleteButton.dataset.deleteId); } 
            else if (target && target.dataset.id) { loadProfile(target.dataset.id, true); }
        });
        
        form.addEventListener('input', updatePreview);
        downloadBtn.addEventListener('click', downloadVCF);
        
        // --- INITIALIZATION ---
        setLanguage(currentLang);
        loadProfilesFromStorage();
        if(profiles.length > 0) {
            const firstProfile = profiles[0];
            if(firstProfile && firstProfile.id) { loadProfile(firstProfile.id); } 
            else { clearForm(); }
        } else { clearForm(); }
    });
</script>
</body>
</html>

